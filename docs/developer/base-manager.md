# ベースマネージャ設計（ドラフト）

このドキュメントでは、制御ブロック、ペイロード格納、リース発行を
調整するベースラインのマネージャ概念を説明する。責務と拡張点を
定義するが、単一の具体実装を規定しない。

## 目的

- リースを発行する最小で再利用可能なマネージャコアを提供する。
- ペイロードのライフタイム管理をスロット再利用から分離する。
- 制御ブロックとペイロードで異なるプール型を選択可能にする。
- リースは軽量なので要求ごとに生成する前提とする。

## 中核概念

### マネージャ

マネージャは2つの異なるプールを所有する:

- **制御ブロックプール**: 制御ブロック（shared/weak/weak-shared）を格納する。
- **ペイロードプール**: 実際のペイロードオブジェクトを格納する。

マネージャは制御ブロックをペイロードスロットに結び付けて
リースを発行する。マネージャは単一の割り当て方針を強制せず、
選択されたプール型とポリシー特性に委譲する。

### 制御ブロック

制御ブロックは次を保持する:

- ペイロードハンドル（index + generation が有効な場合）。
- ペイロードポインタ。
- 参照カウント（強参照/弱参照、ブロック種別に応じて）。

制御ブロックは再利用可能。参照カウントがゼロになり、
ペイロードが解放されたら、制御ブロックはプールへ戻される。

### ペイロード

ペイロードのライフタイムは制御ブロックのライフタイムから分離される:

- ペイロードスロットは制御ブロックとは独立に再利用できる。
- ペイロードの生成と破棄はプール特性または
  カスタムの create/destroy 関数を通じて行う。
- isCreated は「ペイロード中身が構築済みか」を表す。

### リース

リースはマネージャが返す公開ハンドルで、次を持つ:

- 制御ブロックへの参照（ハンドル + ポインタ + generation）。
- 制御ブロックプールへのポインタ（最終解放で返却するため）。

リースの挙動はカテゴリ（shared, weak, weak-shared）で定義される。
マネージャがリースの生成/再利用方式を決定する。

## プール選択

マネージャは以下のプール型を選択できる必要がある:

- 制御ブロック: 通常は再利用のため `SlotPool`。
- ペイロード: `SlotPool`、`FixedSlotStore`、または専用プール。

選択はマネージャ実装が定めるポリシーである。プール API は
型をまたいで互換（initialize, acquire, release, get, emplace, destroy）
であるべきだ。

## リース生成ポリシー

リースは軽量なので acquire のたびに構築する。リースの生成方針は
制御ブロックやペイロードプールの意味論に影響しない。

## ペイロード生成/破棄ポリシー

ペイロードの生成/破棄方針は pool の Traits に集約する。control block は
この方針を持たず、pool が isCreated を更新する。

- `destroy_on_release = true`
  - release で destroy を実行し、isCreated を false に戻す。
  - reserve で未作成 slot を確保し、emplace で作成する。
- `destroy_on_release = false`
  - release では destroy を行わず、isCreated を維持する。
  - acquire は作成済み slot のみ返す（再利用モード）。

## 取得フロー（参照実装）

1. ペイロードプールから slot を取得する（reserve/acquire は派生で固定）。
2. 制御ブロックプールから制御ブロックスロットを取得する。
3. ペイロードのメタデータを制御ブロックに結び付ける。
4. 参照カウントを初期化する。
5. リースを生成または再利用し、返却する。

## 解放フロー（参照実装）

1. リースが制御ブロックへの強参照を減らす。
2. 強参照カウントがゼロになると、リースが
   ペイロードをプールへ返却しようとする。
3. 制御ブロックの参照カウントがゼロになったら、
   制御ブロックをプールへ返却する。
4. リースオブジェクトは破棄されるか、リースプールへ返却される
   （ポリシー次第）。

## 責務

マネージャの責務:

- 制御ブロックとペイロードのプール実装を選択する。
- プール API を使った acquire/release 振る舞いを定義する。
- リースの生成または再利用ポリシーを提供する。
- ペイロードと制御ブロックのプールがマネージャと同じ寿命を
  共有することを保証する（ペイロードプールは、それに束縛される
  制御ブロックより長生きする）。

プールの責務:

- スロットの格納と再利用を管理する。
- ハンドル/インデックス/generation による有効性を追跡する。
- ペイロードの生成/破棄フックを提供する。
- destroy_on_release に従って isCreated を更新する。

制御ブロックの責務:

- 参照カウントを追跡する。
- アクセスと解放のためにペイロードメタデータを束縛する。
- 強参照カウントがゼロになった遷移でペイロード解放をトリガする。

## スレッドセーフティ

- 参照カウントはアトミック。
- プール操作とペイロード束縛はデフォルトでスレッドセーフではなく、
  必要に応じてマネージャが外部同期する必要がある。

## エラーハンドリング方針

- `try*` 系は `bool` を返す（失敗は通常系）。
- `*` ラッパは `try*` に委譲し、失敗時に `throw` する。
- `release` は二重解放などを検出しても例外を投げず、`bool` で失敗を返す。

## マネージャAPI（草案）

基底クラスは最小限の「内部ヘルパ」を提供し、派生クラスが
公開 API をラップして提供する方針とする。

派生が公開する最小セット:

- `initialize(...)`（派生で `grow` / `growAndCreate` を固定）
- `shutdown()`（`canShutdown` が false なら失敗）
- `acquire(...)`（失敗時は例外）
- `tryAcquire(...)`（`bool` で失敗を返す）
- `acquireWeak(...)`（必要な場合のみ）

基底が提供するヘルパ（protected）:

- `allocateSlot(...)`（派生で reserve/acquire を固定）
- `initControlBlock(...)`
- `makeStrongLease(...)` / `makeWeakLease(...)`
- `isInitialized()` などの共通状態管理

## 未解決の問い

- マネージャ API をどの程度 `SlotPool` のメソッドに合わせるべきか。
- acquire がデフォルトで、ペイロード構築用の要求単位ファクトリを
  受け入れるべきかどうか。
